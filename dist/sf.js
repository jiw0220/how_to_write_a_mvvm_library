!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var o in n)("object"==typeof exports?exports:e)[o]=n[o]}}(this,function(){return function(e){function t(o){if(n[o])return n[o].exports;var r=n[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),r=n(3),i=n(4),a=n(5),c=n(7);t.SegmentFault=function(){function e(){this.viewModelPool={},this.viewViewModelMap={},this.renderer=new i.Renderer,this.componentPool={}}return e.prototype.init=function(){var e=this;return new Promise(function(t,n){new a.Loader(e.componentPool).load().then(function(t){return console.log(t),t?(e.generator=new c.ComponentGenerator(e,t),e.generator.scanComponent(document)):void 0}).then(function(){var n=new o.Scanner(e.viewModelPool),i=new r.Watcher(e);for(var a in e.viewModelPool)i.observe(e.viewModelPool[a],e.viewModelChangedHandler);e.viewViewModelMap=n.scanBindDOM(),Object.keys(e.viewViewModelMap).forEach(function(t){e.refresh(t)}),t()})})},e.prototype.registerViewModel=function(e,t){t._alias=e,window[e]=this.viewModelPool[e]=t},e.prototype.refresh=function(e){var t=this;this.viewViewModelMap[e].forEach(function(e){t.renderer.render(e)})},e.prototype.viewModelChangedHandler=function(e,t){this.refresh(e._alias)},e.prototype.registerComponent=function(e,t){this.componentPool[e]=t},e}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(2),r=function(){function e(e){this.prefix="sf-",this.viewModelPool=e}return e.prototype.scanBindDOM=function(){var e=this,t={};return this.getAllBoundElements(this.prefix).forEach(function(n){for(var r=0;r<n.attributes.length;r++){var i=n.attributes[r];if(i.nodeName.search(e.prefix)>-1){var a=i.nodeName,c=n.getAttribute(a);for(var s in e.viewModelPool)if(-1!=c.search(s+".")){var l=new o.BoundItem(e.viewModelPool[s],n,c,a);t[s]?t[s].push(l):t[s]=[l]}}}}),t},e.prototype.fuzzyFind=function(e,t){if(e&&e.attributes)for(var n=0;n<e.attributes.length;n++){var o=e.attributes[n];if(o.nodeName.search(t)>-1)return e}return null},e.prototype.getAllBoundElements=function(e){for(var t=[],n=document.querySelectorAll("*"),o=0;o<n.length;o++){var r=n[o],i=this.fuzzyFind(r,e);i&&t.push(i)}return t},e}();t.Scanner=r},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var BoundItem=function(){function BoundItem(e,t,n,o){this.interactiveDomConfig={INPUT:{text:"input",password:"input",email:"input",url:"input",tel:"input",radio:"change",checkbox:"change",color:"change",date:"change",datetime:"change","datetime-local":"change",month:"change",number:"change",range:"change",search:"change",time:"change",week:"change",button:"N/A",submit:"N/A"},SELECT:"change",TEXTAREA:"change"},this.viewModel=e,this.element=t,this.expression=n,this.attributeName=o,this.addListener(this.element,this.expression)}return BoundItem.prototype.addListener=function(element,expression){var tagName=element.tagName,eventName=this.interactiveDomConfig[tagName];if(eventName){if("object"==typeof eventName){var type=element.getAttribute("type");eventName=eventName[type]}element.addEventListener(eventName,function(e){var newValue=element.value,cmd=expression+'= "'+newValue+'"';try{eval(cmd)}catch(e){console.error(e)}})}},BoundItem}();exports.BoundItem=BoundItem},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e){this.sf=e}return e.prototype.observe=function(e,t){var n=this.sf;for(var o in e){var r=e[o];!function(o,r){"_alias"!==o&&Object.defineProperty(e,o,{get:function(){return r},set:function(i){r=i,console.log("do something after set a new value"),t.call(n,e,o)}})}(o,r)}},e}();t.Watcher=o},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Renderer=function(){function Renderer(){}return Renderer.prototype.render=function(e){var t=this.getValue(e.viewModel,e.expression),n=e.attributeName.split("-")[1];"innertext"===n.toLowerCase()&&(n="innerText"),e.element[n]=t},Renderer.prototype.getValue=function(viewModel,expression){return function(){var alias=viewModel._alias,tempScope={};tempScope[alias]=viewModel;try{var pattern=new RegExp("\\b"+alias+"\\b","gm");expression=expression.replace(pattern,"tempScope."+alias);var result=eval(expression);return tempScope=null,result}catch(e){throw e}}()},Renderer}();exports.Renderer=Renderer},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=function(){function e(e){this.componentDefinitionPool={},this.componentPool=e}return e.prototype.load=function(){var e=[];for(var t in this.componentPool)e.push({name:t,path:this.componentPool[t]});return this.doAsyncSeries(e).then(function(e){return e})},e.prototype.doAsyncSeries=function(e){var t=this;return e.reduce(function(e,n){return e.then(function(e){return fetch(n.path).then(function(e){return e.text().then(function(e){var o=t.getComponentDefinition(n.name,e);return t.componentDefinitionPool[n.name]=o,t.componentDefinitionPool})})})},new Promise(function(e,t){e()}))},e.prototype.getComponentDefinition=function(e,t){var n=document.createElement("div");n.innerHTML=t;var r=n.querySelectorAll("template")[0]&&n.querySelectorAll("template")[0].innerHTML,i=n.querySelectorAll("script")[0]&&n.querySelectorAll("script")[0].innerHTML,a=n.querySelectorAll("style")[0]&&n.querySelectorAll("style")[0].innerHTML;return new o.ComponentDefinition(e,a,r,i)},e}();t.Loader=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t,n,o){this.tagName=e,this.style=t,this.template=n,this.script=o}return e.prototype.generateRealComponent=function(){},e}();t.ComponentDefinition=o},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function c(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(a,c)}s((o=o.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function n(e){return function(t){return o([e,t])}}function o(n){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,i&&(a=i[2&n[0]?"return":n[0]?"throw":"next"])&&!(a=a.call(i,n[1])).done)return a;switch(i=0,a&&(n=[0,a.value]),n[0]){case 0:case 1:a=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,i=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(a=s.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){s.label=n[1];break}if(6===n[0]&&s.label<a[1]){s.label=a[1],a=n;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(n);break}a[2]&&s.ops.pop(),s.trys.pop();continue}n=t.call(e,s)}catch(e){n=[6,e],i=0}finally{r=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var r,i,a,c,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return c={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c};Object.defineProperty(exports,"__esModule",{value:!0});var ComponentGenerator=function(){function ComponentGenerator(e,t){this.componentDefinitionPool=t,this.sf=e}return ComponentGenerator.prototype.scanComponent=function(e){return __awaiter(this,void 0,void 0,function(){var t,n,o,r;return __generator(this,function(i){switch(i.label){case 0:return(t=this.componentDefinitionPool[e.localName])?(n=e.attributes,[2,this.generate(e,t,n)]):[3,1];case 1:if(!(e.children&&e.children.length>0))return[3,6];o=0,i.label=2;case 2:return o<e.children.length?(r=e.children[o],[4,this.scanComponent(r)]):[3,5];case 3:i.sent(),i.label=4;case 4:return o++,[3,2];case 5:case 6:return[2,e]}})})},ComponentGenerator.prototype.generate=function(tagElement,compDef,attrs){return __awaiter(this,void 0,void 0,function(){function callInit(){vm_instance&&vm_instance._init&&"function"==typeof vm_instance._init&&vm_instance._init()}var randomAlias,template,tempFragment,htmlDom,vm_instance,debugComment,script,ViewModelClass,i,attr,eventName,setTarget,i,attr,j,child;return __generator(this,function(_a){switch(_a.label){case 0:if(compDef.style&&this.dealWithShadowStyle(compDef),randomAlias="vm_"+Math.floor(1e4*Math.random()).toString(),template=compDef.template,template=template.replace(new RegExp("this","gm"),randomAlias),tempFragment=document.createElement("div"),tempFragment.insertAdjacentHTML("afterBegin",template),tempFragment.children.length>1&&(template=tempFragment.outerHTML),tagElement.insertAdjacentHTML("beforeBegin",template),htmlDom=tagElement.previousElementSibling,htmlDom.classList.add(tagElement.localName),compDef.script)for(debugComment="//# sourceURL="+tagElement.tagName+".js",script=compDef.script+debugComment,ViewModelClass=new Function(script),vm_instance=new ViewModelClass.prototype.constructor,this.sf.registerViewModel(randomAlias,vm_instance),vm_instance._dom=htmlDom,vm_instance.dispatchEvent=function(e,t,n,o){void 0===n&&(n=!1),void 0===o&&(o=!0);var r=new CustomEvent(e.toLowerCase(),{bubbles:n,cancelable:o});r.data=t,vm_instance._dom.dispatchEvent(r)},i=0;i<attrs.length;i++)attr=attrs[i],-1!==attr.nodeName.search("sf-")&&(-1!==attr.nodeName.search("sf-on")?(eventName=attr.nodeName.substr(5),vm_instance._dom.addEventListener(eventName,eval(attr.nodeValue))):(setTarget=attr.nodeName.split("-")[1],vm_instance[setTarget]=eval(attr.nodeValue)));for(i=0;i<attrs.length;i++)attr=attrs[i],-1===attr.nodeName.search("sf-")&&htmlDom.setAttribute(attr.nodeName,attr.nodeValue);if(tagElement.parentNode.removeChild(tagElement),!(htmlDom.children&&htmlDom.children.length>0))return[3,5];j=0,_a.label=1;case 1:return j<htmlDom.children.length?(child=htmlDom.children[j],[4,this.scanComponent(child)]):[3,4];case 2:_a.sent(),_a.label=3;case 3:return j++,[3,1];case 4:case 5:return callInit(),[2,htmlDom];case 6:return[2]}})})},ComponentGenerator.prototype.dealWithShadowStyle=function(e){var t=e.style,n=e.tagName,o=document.getElementsByTagName("HEAD")[0],r=document.createElement("style");r.type="text/css";var i=t.split("}"),a=[];i.forEach(function(e,t){var n=e.replace(/^\s*/,"");n&&a.push(n)}),t=a.join("}\n."+n+" "),t="."+n+" "+t+"}",r.innerHTML=t,o.appendChild(r)},ComponentGenerator}();exports.ComponentGenerator=ComponentGenerator}])});
//# sourceMappingURL=sf.js.map